# ç³»ç»Ÿæ€§è¯Šæ–­ Runbook

æŒ‰æ–¹æ³•è®ºç³»ç»Ÿåˆ†æ OpenClaw è¿è¡ŒçŠ¶å†µï¼Œè¾“å‡ºç»“æ„åŒ–æŠ¥å‘Šï¼Œå¹¶å°†æ–°å‘ç°æ²‰æ·€åˆ° fault-patterns.mdã€‚

## å‚æ•°

- **days** (å¯é€‰): åˆ†ææ—¶é—´èŒƒå›´ï¼Œé»˜è®¤ 7 å¤©
- **host** (å¯é€‰): è¿œç¨‹ Gateway åœ°å€ (é€šè¿‡ SSH)

## æµç¨‹

### 0. ç¡®è®¤æ‰§è¡Œç¯å¢ƒ

âš ï¸ æ¯æ¬¡æ‰§è¡Œå‰å¿…é¡»ç¡®è®¤"ä½ åœ¨å“ªå°æœºå™¨ä¸Š"ï¼š
```bash
echo "ğŸ–¥ï¸ å½“å‰: $(hostname) | $(whoami) | $(ipconfig getifaddr en0 2>/dev/null || hostname -I 2>/dev/null | awk '{print $1}')"
```

### 1. å®šä½æ—¥å¿—

```bash
HOST="${host:-}"
CMD="${HOST:+ssh -o IdentitiesOnly=yes -o ConnectTimeout=10 $HOST}"

LOG_DIR=$($CMD bash -c 'echo ${OPENCLAW_LOG_DIR:-~/.openclaw/logs}')
GATEWAY_LOG="$LOG_DIR/gateway.log"
ERR_LOG="$LOG_DIR/gateway.err.log"

$CMD test -f "$ERR_LOG" || echo "ERROR: $ERR_LOG not found"
```

### 2. é‡åŒ–æ¦‚è§ˆ

```bash
DAYS="${days:-7}"
SINCE=$(date -v-${DAYS}d '+%Y-%m-%d' 2>/dev/null || date -d "$DAYS days ago" '+%Y-%m-%d')

TOTAL_LINES=$($CMD wc -l < "$ERR_LOG" | tr -d ' ')
TOTAL_ERRORS=$($CMD grep -c "." "$ERR_LOG")
UNHANDLED=$($CMD grep -c "UnhandledPromiseRejection\|unhandled" "$ERR_LOG")
BAK_COUNT=$($CMD ls ~/.openclaw/openclaw.json.bak* 2>/dev/null | wc -l | tr -d ' ')
```

### 3. å…­ç»´åˆ†ç±»

è¯»å– `log-analysis-methodology.md` ä¸­çš„åˆ†ç±»æ–¹æ³•ï¼Œæ‰§è¡Œ:

| ç»´åº¦ | å‘½ä»¤ | è¾“å‡º |
|------|------|------|
| ç½‘ç»œ | `grep -c "fetch failed"` | æ¬¡æ•° + æ¯æ—¥åˆ†å¸ƒ |
| é…ç½® | `grep -c "invalid character\|config reload skipped"` | æ¬¡æ•° + è¡Œå· |
| è®¤è¯ | `grep -c "No API key\|401\|429"` | æ¬¡æ•° + provider |
| å·¥å…· | `grep "\[tools\]" \| sort \| uniq -c` | æŒ‰å·¥å…·åˆ†ç±» |
| è¿›ç¨‹ | `grep -c "SIGTERM\|Gateway listening"` | é‡å¯æ¬¡æ•° + crash loop æ£€æµ‹ |
| SSH/è¿œç¨‹ | `grep -c "Host key verification\|Too many authentication\|Permission denied"` | æ¬¡æ•° + ç›®æ ‡ host |

### 4. æ¨¡å¼åŒ¹é…

è¯»å– `fault-patterns.md`ï¼Œå°†åˆ†æç»“æœä¸å·²çŸ¥æ¨¡å¼å¯¹æ¯”:

```
å¯¹æ¯ä¸ªå·²çŸ¥æ¨¡å¼:
  æœç´¢å…¶ "ç­¾å" å…³é”®è¯
  å¦‚æœå‘½ä¸­ â†’ è®°å½•ä¸º "å·²çŸ¥æ•…éšœ (æœ‰ä¿®å¤æ–¹æ¡ˆ)"
  å¦‚æœæœªå‘½ä¸­ â†’ è·³è¿‡

å¯¹æœªåŒ¹é…çš„é«˜é¢‘é”™è¯¯:
  æ ‡è®°ä¸º "æœªçŸ¥æ¨¡å¼ â€” éœ€è¦äººå·¥ç¡®è®¤"
```

### 5. è¾“å‡ºè¯Šæ–­æŠ¥å‘Š

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¥ OpenClaw è¯Šæ–­æŠ¥å‘Š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“… åˆ†æèŒƒå›´: <start> ~ <end> (<N> å¤©)
ğŸ“Š æ—¥å¿—è§„æ¨¡: <N> è¡Œ (gateway.log) + <N> è¡Œ (err.log)

ğŸ”´ å¥åº·è¯„åˆ†: <åˆ†æ•°>/100

ğŸ“ˆ æ¦‚è§ˆ
   æ€»é”™è¯¯:       <N> æ¡
   æœªå¤„ç†å¼‚å¸¸:   <N> æ¬¡
   Gateway é‡å¯: <N> æ¬¡
   é…ç½®å¤‡ä»½:     <N> ä¸ª (æ‰‹åŠ¨ç¼–è¾‘é¢‘ç‡æŒ‡æ ‡)

ğŸ” æ•…éšœåˆ†ç±»
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ç»´åº¦     â”‚ æ•°é‡ â”‚ ä¸¥é‡åº¦ â”‚ é¡¶éƒ¨é”™è¯¯                     â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ ç½‘ç»œ     â”‚ <N>  â”‚ ğŸ”´/ğŸŸ¡/ğŸŸ¢ â”‚ fetch failed: <N>           â”‚
   â”‚ é…ç½®     â”‚ <N>  â”‚ ...    â”‚ invalid character: <N>       â”‚
   â”‚ è®¤è¯     â”‚ <N>  â”‚ ...    â”‚ No API key: <N>              â”‚
   â”‚ å·¥å…·     â”‚ <N>  â”‚ ...    â”‚ exec: <N>, browser: <N>      â”‚
   â”‚ è¿›ç¨‹     â”‚ <N>  â”‚ ...    â”‚ crash loop: <Y/N>            â”‚
   â”‚ SSH/è¿œç¨‹ â”‚ <N>  â”‚ ...    â”‚ host key: <N>, auth: <N>     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ”— å·²çŸ¥æ¨¡å¼å‘½ä¸­
   âœ… [fetch failed æš´å¢] â€” ç½‘ç»œ/VPN ä¸ç¨³å®š â†’ è§ fault-patterns.md
   âœ… [JSON è¯­æ³•é”™è¯¯] â€” line <N> â†’ jq ä¿®å¤
   â“ [æœªçŸ¥æ¨¡å¼] â€” "<æ–°é”™è¯¯ç­¾å>" (éœ€äººå·¥ç¡®è®¤)

ğŸ’Š å»ºè®®æ“ä½œ (æŒ‰ä¼˜å…ˆçº§)
   1. [P0] <æœ€ç´§æ€¥çš„ä¿®å¤åŠ¨ä½œ>
   2. [P1] <æ¬¡è¦ä¿®å¤>
   3. [P2] <é¢„é˜²æ€§å»ºè®®>

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### 6. æ²‰æ·€æ–°å‘ç°

å¦‚æœå‘ç° **fault-patterns.md ä¸­æ²¡æœ‰çš„æ–°æ¨¡å¼**:

1. ç¡®è®¤å®ƒä¸æ˜¯å·²çŸ¥æ¨¡å¼çš„å˜ä½“
2. å‘ç”¨æˆ·ç¡®è®¤æ ¹å› åˆ†ææ˜¯å¦æ­£ç¡®
3. **è¿½åŠ åˆ° fault-patterns.md**ï¼Œæ ¼å¼:

```markdown
### [æ–°æ¨¡å¼åç§°]
- **ç­¾å**: `[å…·ä½“æ—¥å¿—å…³é”®è¯]`
- **æ ¹å› **: [åˆ†æå¾—å‡ºçš„æ ¹å› ]
- **å½±å“**: [å½±å“èŒƒå›´]
- **ä¿®å¤**: [ä¿®å¤æ­¥éª¤]
- **é¢„é˜²**: [é¢„é˜²å»ºè®®]
- **é¦–æ¬¡å‘ç°**: [ä»Šå¤©æ—¥æœŸ]
```

4. æäº¤å˜æ›´:
```bash
cd <openclaw-dev-path>
git add skills/openclaw-dev-knowledgebase/references/fault-patterns.md
git commit -m "diagnose: add fault pattern â€” <æ¨¡å¼åç§°>"
```

### 7. å¥åº·è¯„åˆ†è®¡ç®—

```
100 åˆ†åŸºå‡†ï¼ŒæŒ‰ä»¥ä¸‹æ‰£åˆ†:

æ¯æ—¥é”™è¯¯ > 200:        -20
fetch failed > 50/å¤©:   -15
é…ç½®è§£æå¤±è´¥ > 0:       -25 (å¯é¢„é˜²!)
crash loop å­˜åœ¨:        -20
å·¥å…·å¤±è´¥ç‡ > 15%:       -10
.bak å¢é€Ÿ > 3/å‘¨:       -10
```
